---
import type { DefaultNodeTypes } from "@payloadcms/richtext-lexical";
import type { SerializedEditorState } from "@payloadcms/richtext-lexical/lexical";
import AutoLinkAstroConverter from "../converters/AutoLinkAstroConverter.astro";
import BlockQuoteAstroConverter from "../converters/BlockQuoteAstroConverter.astro";
import HeadingAstroConverter from "../converters/HeadingAstroConverter.astro";
import HorizontalRuleAstroConverter from "../converters/HorizontalRuleAstroConverter.astro";
import LineBreakAstroConverter from "../converters/LineBreakAstroConverter.astro";
import LinkAstroConverter from "../converters/LinkAstroConverter.astro";
import ListAstroConverter from "../converters/ListAstroConverter.astro";
import ListItemAstroConverter from "../converters/ListItemAstroConverter.astro";
import ParagraphAstroConverter from "../converters/ParagraphAstroConverter.astro";
import TabAstroConverter from "../converters/TabAstroConverter.astro";
import TableAstroConverter from "../converters/TableAstroConverter.astro";
import TableCellAstroConverter from "../converters/TableCellAstroConverter.astro";
import TableRowAstroConverter from "../converters/TableRowAstroConverter.astro";
import TextAstroConverter from "../converters/TextAstroConverter.astro";
import UploadAstroConverter from "../converters/UploadAstroConverter.astro";
import type {
	AstroConverters,
	AstroConvertersFunction,
	RichTextConfig,
} from "../types";
import RenderNode from "./RenderNode.astro";

const defaultAstroConverters: AstroConverters<DefaultNodeTypes> = {
	paragraph: ParagraphAstroConverter,
	text: TextAstroConverter,
	heading: HeadingAstroConverter,
	link: LinkAstroConverter,
	autolink: AutoLinkAstroConverter,
	list: ListAstroConverter,
	listitem: ListItemAstroConverter,
	quote: BlockQuoteAstroConverter,
	horizontalrule: HorizontalRuleAstroConverter,
	linebreak: LineBreakAstroConverter,
	tab: TabAstroConverter,
	table: TableAstroConverter,
	tablerow: TableRowAstroConverter,
	tablecell: TableCellAstroConverter,
	upload: UploadAstroConverter,
};

type Props = {
	data: SerializedEditorState;
	converters?: AstroConverters | AstroConvertersFunction;
	config?: RichTextConfig;
	class?: string;
};

const {
	data,
	converters,
	config = {
		disableContainer: false,
		disableIndent: false,
		disableTextAlign: false,
	},
	class: className = "payload-richtext",
} = Astro.props;

let finalConverters: AstroConverters = {};
if (converters) {
	if (typeof converters === "function") {
		finalConverters = converters({ defaultConverters: defaultAstroConverters });
	} else {
		finalConverters = converters;
	}
} else {
	finalConverters = defaultAstroConverters;
}

const nodes = data?.root?.children || [];

const Container = config.disableContainer ? Fragment : "div";

const containerProps = config.disableContainer ? {} : { class: className };
---

<Container {...containerProps}>
  {
    nodes.map((node) => (
      <RenderNode node={node} converters={finalConverters} config={config} />
    ))
  }
</Container>
